<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
</head>

<body style="background-color: rgb(128, 128, 255);">
  <script src="../_bundle/lib/phina.js"></script>
  <script>phina.globalize()</script>
  <script src="../_bundle/lib/phigl.js"></script>
  <script src="../src/megaparticle/ParticleSystem.js"></script>
  <script src="../src/megaparticle/Emitter.js"></script>
  <script>
    const canvas = document.createElement("canvas");
    canvas.width = 1024;
    canvas.height = 512;
    document.body.appendChild(canvas);
    const gl = canvas.getContext("webgl");
    gl.clearColor(0.0, 0.0, 0.0, 1.0);

    const loader = AssetLoader();
    loader.load({
      json: {
        "fire.particle": "../src/particle2dx/fire.json",
      },
      image: {
        "fire.png": "../src/particle2dx/fire.png",
      },
      vertexShader: {
        "mega_init.vs": "../_bundle/asset/shader/megaparticle/mega_init.vs",
        "mega_emit.vs": "../_bundle/asset/shader/megaparticle/mega_emit.vs",
        "mega_update.vs": "../_bundle/asset/shader/megaparticle/mega_update.vs",
        "mega_draw.vs": "../_bundle/asset/shader/megaparticle/mega_draw.vs",
        "mega_test.vs": "../_bundle/asset/shader/megaparticle/mega_test.vs",
        "mega_copy.vs": "../_bundle/asset/shader/megaparticle/mega_copy.vs",
        "mega_set.vs": "../_bundle/asset/shader/megaparticle/mega_set.vs",
      },
      fragmentShader: {
        "mega_init.fs": "../_bundle/asset/shader/megaparticle/mega_init.fs",
        "mega_emit.fs": "../_bundle/asset/shader/megaparticle/mega_emit.fs",
        "mega_update.fs": "../_bundle/asset/shader/megaparticle/mega_update.fs",
        "mega_draw.fs": "../_bundle/asset/shader/megaparticle/mega_draw.fs",
        "mega_test.fs": "../_bundle/asset/shader/megaparticle/mega_test.fs",
        "mega_copy.fs": "../_bundle/asset/shader/megaparticle/mega_copy.fs",
        "mega_set.fs": "../_bundle/asset/shader/megaparticle/mega_set.fs",
      },
    });
    loader.on("load", () => {
      main();
    });

    const main = () => {
      const particleJson = AssetManager.get("json", "fire.particle").data;
      console.log(particleJson);

      const mega = megaparticle.ParticleSystem({ gl });

      const texImage = phigl.ImageUtil.resizePowOf2({ src: "fire.png" });
      document.body.appendChild(texImage.domElement);
      mega.registerTexture("fire.png", texImage);

      const emitters = [];
      for (let i = 0; i < 5; i++) {
        const emitter = mega.createEmitter(particleJson);
        emitter.x = Random.randint(0, canvas.width);
        emitter.y = Random.randint(0, canvas.height);
        emitters.push(emitter);
      }

      // mega.set({
      //   index: 0,
      //   section0: [0.0, 5.0, 256.0, 256.0],
      //   section1: [0.0, 0.0, 0.0, 0.0],
      //   section2: [0.0, 64.0, 64.0, 0.0],
      //   section3: [0.0, 10.0, 0.0, 0.0],
      //   section4: [1.0, 1.0, 1.0, 0.1],
      //   section5: [1.0, 1.0, 1.0, 0.1],
      //   section6: [32.0, 32.0, 0.0, 0.0],
      // });
      // canvas.width = megaparticle.ParticleSystem.texSize;
      // canvas.height = megaparticle.ParticleSystem.texSize;
      // mega.test();

      let time = Date.now();
      let stats = null;
      const loop = () => {
        const deltaTime = Date.now() - time;
        emitters.forEach(e => e.update({ deltaTime }));
        mega.update(deltaTime * 0.001);
        time += deltaTime;

        gl.viewport(0, 0, canvas.width, canvas.height);
        gl.clearColor(0, 0, 0, 1);
        gl.clearDepth(1.0);
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
        mega.draw(canvas.width, canvas.height);

        gl.flush();

        stats && stats.update();

        requestAnimationFrame(loop);
      };
      requestAnimationFrame(loop);

      const STATS_URL = 'https://cdnjs.cloudflare.com/ajax/libs/stats.js/r14/Stats.js';
      const script = document.createElement('script');
      script.src = STATS_URL;
      document.body.appendChild(script);
      script.onload = () => {
        stats = new Stats();
        document.body.appendChild(stats.domElement);
      };
    };
  </script>
</body>

</html>